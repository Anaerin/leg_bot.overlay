<!DOCTYPE html>
<html lang="en">
<head>
	<title>WebSocket Echo Client</title>
	<meta charset="UTF-8" />
	<style type="text/css">
		html, body {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}

		.leftside {
			width: 50%;
			margin: 0px;
			padding: 0px;
			position: absolute;
			top: 0px;
			left: 0px;
            height: 100%;
		}

		.rightside {
			width: 50%;
			margin: 0px;
			padding: 0px;
			position: absolute;
			right: 2px;
			top: 0px;
			bottom: 0px;
			max-height: 100%;
            overflow: hidden;
            background-color: #cccccc;
		}

		.rightside #MessageLog {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 1.75em;
            overflow: hidden;
            display: table-cell;
            vertical-align: bottom;
		}	
        .rightside .ChatLine {
            margin-left: 9em;
            border-left: 2px inset #cccccc;
            padding-left: 0.5em;
        }
        .rightside .WhisperLine {
            margin-left: 9em;
            border-left: 2px inset #cccccc;
            padding-left: 0.5em;
            font-style: italic;
        }
        .rightside #ChatInput {
				position: absolute;
				bottom: 0px;
				right: 0px;
				left: 5px;
                width: 100%;
			}
            
			.rightside img.emoticon {
				height: 2em;
			}
			.rightside div.UserName {
				display: inline-block;
                width: 8em;
                text-align: right;
                margin-right: 1em;
                margin-left: -9em;
			}
            .rightside div.Broadcaster {
                font-weight: bold;
            }
			.DebugScroll {
				position: absolute;
				bottom: 0px;
				left: 0px;
				width: 100%;
                overflow: hidden;
                display: table-cell;
                vertical-align: bottom;
                background-color: #cccccc;
                max-height: 50%;
			}
			.DebugScroll div {

			}
	</style>
</head>
<body>
	<div class="leftside">
		Status: <span id="status"></span><br />
		Message: <span id="message"></span><br />
		<input id="open" type="button" value="Connect" />&nbsp;
		<input id="close" type="button" value="Disconnect" /><br />
		<fieldset>
			<legend>Webcam Controls</legend>
			<button id="GetWebcams">List Webcams</button>
			<select id="WebcamList"></select>
			<button id="SetWebcam">Set Webcam</button><br />
			<button id="ShowWebcam">Show Webcam</button>
			<button id="HideWebcam">Hide Webcam</button>
		</fieldset>
		<fieldset>
			<legend>Switch Screens</legend>
			<button id="SwitchToAFK">Switch to AFK</button>
			<button id="SwitchToGame">Switch to Game</button>
			<button id="SwitchToBooth">Switch to Booth</button>
		</fieldset>
		<input type="text" name="GameComment" id="GameComment" placeholder="Comment" /><button id="UpdateComment">Update Comment</button><br />
		<input type="text" name="AFKComment" id="AFKComment" placeholder="AFK Message" /><button id="UpdateAFK">Update AFK Message</button><br />
		<input type="text" name="FollowerName" id="FollowerName" placeholder="Follower Name" /><button id="TestFollow">Test New Follower</button><br />
		<input type="text" name="DonationName" id="DonationName" placeholder="Donator" /><input type="text" name="DonationCurrencySymbol" id="DonationCurrencySymbol" placeholder="$" /><input type="text" name="DonationAmount" id="DonationAmount" placeholder="0.00" /><button id="TestDonation">Test New Donation</button><br />
		<input type="text" name="CounterName" id="CounterName" placeholder="Counter Name"/><input type="text" name="CounterValue" id="CounterValue" placeholder="5" /><button id="TestCounter">Test Counter Update</button>
		<div class="DebugScroll" id="DebugScroll"></div>
	</div>
	<div class="rightside"><div id="MessageLog"></div><input type="text" name="ChatInput" id="ChatInput" /></div>
	<script language="JavaScript" type="text/javascript">
		"use strict";
		// Initialize everything when the window finishes loading
		var socket;
		function sendChat(text) {
			if (socket) {
				socket.send(JSON.stringify({ type: "ChatInput", value: text }));
			}
		}
		document.getElementById("ChatInput").addEventListener("keyup", function (event) {
			if (event.keyCode == 13) {
				sendChat(event.currentTarget.value);
				event.currentTarget.value = "";
				event.preventDefault();
				event.returnValue = false;
			}
		});
		function htmlEscape(str) {
		    return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
		}
		function formatUser(userState) {
		    var output = "<div class=\"UserName Turbo ";
		    if (userState.badges) {
		        if (userState.badges.broadcaster == 1) output += "Broadcaster ";
		        if (userState.badges.moderator == 1) output += "Moderator ";
		        if (userState.badges.turbo == 1) output += "Turbo ";
		        if (userState.badges.subscriber == 1) output += "Subscriber ";
		    }
		    output += "\">" + userState['display-name'] + "</div>";
		    return output;
		}
		function formatChatMessage(message) {
			return "<div class=\"ChatLine\">" + formatUser(message.userstate) + formatEmotes(message.message, message.userstate.emotes) + "</div>";
		}
		function formatWhisperMessage(message) {
		    return "<div class=\"WhisperLine\">" + formatUser(message.userstate) + formatEmotes(message.message, message.userstate.emotes) + "</div>";
		}
		function formatEmotes(text, emotes) {
			var splitText = text.split('');
			for (var i in emotes) {
				var e = emotes[i];
				for (var j in e) {
					var mote = e[j];
					if (typeof mote == 'string') {
						mote = mote.split('-');
						mote = [parseInt(mote[0]), parseInt(mote[1])];
						var length = mote[1] - mote[0],
							empty = Array.apply(null, new Array(length + 1)).map(function () { return '' });
						splitText = splitText.slice(0, mote[0]).concat(empty).concat(splitText.slice(mote[1] + 1, splitText.length));
						splitText.splice(mote[0], 1, '<img class="emoticon" src="http://static-cdn.jtvnw.net/emoticons/v1/' + i + '/3.0">');
					}
				}
			}
			return splitText.join('');
		}

		function connectSocket(url) {
			socket = new WebSocket(url, "control");

			socket.onopen = function (event) {
				document.getElementById("close").disabled = false;
				document.getElementById("open").disabled = true;
				document.getElementById("status").innerHTML = "Connected";
				var buttons = document.getElementsByTagName("button");
				for (var i = 0; i < buttons.length; i++) {
					buttons[i].disabled = false;
				}
			};

			// Display messages received from the server
			socket.onmessage = function (event) {
			    document.getElementById("message").innerHTML = "Server Says: " + event.data;
			    document.getElementById("DebugScroll").innerHTML += "<div>" + htmlEscape(event.data) + "</div>";
			    document.getElementById("DebugScroll").lastChild.scrollIntoView();
				console.log("Got message: %s", event.data);
				var messageObj = {};
				try {
					messageObj = JSON.parse(event.data);
				} catch (e) {
					// Not JSON, we don't care;
					return;
				}
				if (messageObj.type == "NeedAuth") {
					//window.alert('Taking you to: ' + messageObj.value);
					window.location.href = messageObj.value;
				}
				if (messageObj.type == "ChatMessage") {
				    document.getElementById("MessageLog").innerHTML += formatChatMessage(messageObj);
				}
				if (messageObj.type == "ChatWhisper") {
				    document.getElementById("MessageLog").innerHTML += formatWhisperMessage(messageObj);
				}
				if (messageObj.name == "Webcam") {
					var newOpt = document.createElement("option");
					newOpt.value = messageObj.CamID;
					newOpt.appendChild(document.createTextNode(messageObj.CamName));
					document.getElementById("WebcamList").appendChild(newOpt);
				}
                if (document.getElementById("MessageLog").lastChild) document.getElementById("MessageLog").lastChild.scrollIntoView();
			};

			// Display any errors that occur
			socket.addEventListener("error", function (event) {
				document.getElementById("message").innerHTML = "Error: " + event.message;
			});

			socket.addEventListener("close", function (event) {
				var buttons = document.getElementsByTagName("button");
				for (var i = 0; i < buttons.length; i++) {
					buttons[i].disabled = true;
				}
				document.getElementById("status").innerHTML = "Not Connected";
				document.getElementById("open").disabled = false;
			});
		}
		window.addEventListener("load", function (event) {
			// Create a new connection when the Connect button is clicked
			document.getElementById("open").addEventListener("click", function (event) {
				document.getElementById("open").disabled = true;
				connectSocket("ws://" + location.host);
			});

			// Close the connection when the Disconnect button is clicked
			document.getElementById("close").addEventListener("click", function (event) {
				document.getElementById("close").disabled = true;
				document.getElementById("message").innerHTML = "Disconnecting...";
				socket.close();
			});
			var buttons = document.getElementsByTagName("button");
			for (var i = 0; i < buttons.length; i++) {
				buttons[i].disabled = true;
			}
			document.getElementById("status").innerHTML = "Connecting...";
			document.getElementById("close").disabled = true;
			connectSocket("ws://" + location.host);

			// Send events.
			var buttonEvents = {
				"GetWebcams": function (event) {
					var webcamList = document.getElementById("WebcamList");
					while (webcamList.firstChild) {
						webcamList.removeChild(webcamList.firstChild);
					}
					socket.send(JSON.stringify({ type: "GetWebcams", data: "" }));
				},
				"SetWebcam": function (event) {
					socket.send(JSON.stringify({ type: "SetWebcam", data: document.getElementById("WebcamList").value }));
				},
				"ShowWebcam": function (event) {
					socket.send(JSON.stringify({ type: "ShowWebcam", data: "" }));
				},
				"HideWebcam": function (event) {
					socket.send(JSON.stringify({ type: "HideWebcam", data: "" }));
				},
				"SwitchToAFK": function (event) {
					socket.send(JSON.stringify({ type: "SwitchToAFK", data: "" }));
				},
				"SwitchToGame": function (event) {
					socket.send(JSON.stringify({ type: "SwitchToGame", data: "" }));
				},
				"SwitchToBooth": function (event) {
					socket.send(JSON.stringify({ type: "SwitchToBooth", data: "" }));
				},
				"TestFollow": function (event) {
					socket.send(JSON.stringify({ type: "TestFollow", data: { username: document.getElementById("FollowerName").value } }));
				},
				"TestDonation": function (event) {
					var Name = document.getElementById("DonationName").value;
					var Symbol = document.getElementById("DonationCurrencySymbol").value;
					if (Symbol == "") Symbol = "$";
					var Amount = document.getElementById("DonationAmount").value;
					Amount = Number(Amount).toFixed(2);
					socket.send(JSON.stringify({ type: "TestDonation", data: { username: Name, currencySymbol: Symbol, amount: Amount } }));
				},
				"UpdateComment": function (event) {
					socket.send(JSON.stringify({ type: "UpdateComment", data: document.getElementById("GameComment").value }));
				},
				"UpdateAFK": function (event) {
					socket.send(JSON.stringify({ type: "UpdateAFK", data: document.getElementById("AFKComment").value }));
				},
				"TestCounter": function (event) {
					socket.send(JSON.stringify({ type: "TestStat", data: { action: "StatChanged", stat: document.getElementById("CounterName").value, value: document.getElementById("CounterValue").value } }));
				}
			}
			Object.keys(buttonEvents).forEach(function (button) {
				document.getElementById(button).addEventListener("click", buttonEvents[button]);
			});
		});

</script>
</body>
</html>