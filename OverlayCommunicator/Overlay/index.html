<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<title>Nobody sees this anyway.</title>
	<link type="text/css" rel="stylesheet" href="css/stylesheet-new.css" />
	<script language="Javascript" type="text/javascript" src="js/adapter.js"></script>
	<script language="Javascript" type="text/javascript" src="js/WebCamDisplay.js"></script>
	<script language="Javascript" type="text/javascript" src="js/ChatProcessor.js"></script>
</head>
<body>
	<div class="MainWindow"></div>
	<div class="LeftHolder"></div>
	<div class="Logo">A</div>
	<div class="AFKWindow Hidden" id="afkWindow"><div class="AFKImage" id="AFKMessage"></div></div>
	<div class="InfoLine">Currently Playing: <span id="Game"></span></div>
	<div class="ProgressLine"><progress id="progressBar"></progress><label for="progressBar" id="progressLabel"></label></div>
	<fieldset class="EmptyFieldset Donators"><legend>Donations</legend><marquee id="donatorList"></marquee></fieldset>
	<div class="CounterHolder">
		<fieldset class="Hidden Counter"><legend>Bad Puns</legend><counter data-name="badpun" id="badpun">0</counter></fieldset>
		<fieldset class="Hidden Counter"><legend>Deaths</legend><counter data-name="death" id="death">0</counter></fieldset>
	</div>
	<div class="PopupHolder">
		<fieldset class="Follower"><legend>Follows</legend><span id="FollowerAlert"></span><span id="FollowerCount">0</span></fieldset>
	</div>
	<div class="VideoHolder" id="VideoHolder"><video id="webcam" style="width: 100%;" autoplay="autoplay"></video></div>
	<div class="MessageLog" id="MessageLog"></div>
	<div id="alert" class=""></div>
	<script language="JavaScript" type="text/javascript">
		var messageCap = 20;
		function SetAFKMessage(message) {
			document.getElementById("AFKMessage").innerText = message;
		}

		function ToggleWebcam() {
			document.getElementById("VideoHolder").classList.toggle("Hidden");
		}
		function GoAFK() {
			document.documentElement.classList.remove("Booth");
			document.documentElement.classList.add("AFK");
		}
		
		function GoBooth() {
			document.documentElement.classList.add("Booth");
			document.documentElement.classList.remove("AFK");
		}

		function GoGame() {
			document.documentElement.classList.remove("Booth");
			document.documentElement.classList.remove("AFK");
		}
		var updateQueue = [];
		var queueTimeout;
		var processingQueue = false;
		var followers = [];
		function UpdateGame(gameName) {
			document.getElementById("Game").innerHTML = gameName;
		}

		function PullQueue() {
			if (!processingQueue) {
				if (updateQueue.length > 0) {
					processingQueue = true;
					var task = updateQueue.shift();
					task.callback(...task.arguments);
					queueTimeout = setTimeout(ProcessNext, task.timeout, task.cleanup);
				} else {
					processingQueue = false;
				}
			}
		}

		function ProcessNext(cleanup) {
			if (cleanup) cleanup();
			processingQueue = false;
			PullQueue();
		}

		function AddToQueue(task) {
			updateQueue.push(task);
			if (!processingQueue) PullQueue();
		}

		function UpdateCounter(counter, value) {
			var counterID = document.getElementById(counter);
			counterID.innerHTML = value;
			counterID.classList.add("updated");
			counterID.timeout = setTimeout(function (counterID) {
				counterID.classList.remove("updated");
			}, 7000, counterID);
		}

		function NewFollower(followerName) {
			document.getElementById("FollowerAlert").innerHTML = followerName;
			document.getElementById("FollowerAlert").parentElement.classList.add("visible");
			document.getElementById("FollowerAlert").timeout = setTimeout(function () {
				document.getElementById("FollowerAlert").parentElement.classList.remove("visible");
			}, 7000);
			followers.push(followerName);
			document.getElementById("FollowerCount").innerHTML = followers.length;
		}

		function ChatMessage(type, message) {
			switch (type) {
				case 'Chat':
					appendChatMessage(message, messageCap, formatChatMessage);
					break;
				case 'Action':
					appendChatMessage(message, messageCap, formatActionMessage);
					break;
				default:

					break;
			}
		}

		function ChatTimeout(message) {
			var messages = document.getElementById("MessageLog").childNodes;
			for (var i = messages.length; i > 0; i--) {
				if (messages[i].username == message.username) {
					messages[i].parentElement.removeChild(messages[i]);
				}
			}
		}

		function GoalUpdate(goal) {
			if (goal.active) {
				document.getElementById("progressBar").style.display = "";
				document.getElementById("progressLabel").style.display = "";
				document.getElementById("progressBar").max = goal.cents;
				document.getElementById("progressBar").value = goal.progress.cents;
				document.getElementById("progressLabel").innerHTML = htmlEscape(goal.title) + ": " + goal.progress.currencySymbol + goal.progress.amount + "/" + goal.progress.currencySymbol + goal.amount + " (" + goal.progress.percentage + "%)";
			} else {
				document.getElementById("progressBar").style.display = "none";
				document.getElementById("progressLabel").style.display = "none";
			}
		}

		function NewTip(tip) {
			var alertObj = document.getElementById("alert");
			alertObj.innerHTML = htmlEscape(tip.user.displayName) + " Just donated " + tip.currencySymbol + tip.amount + "!";
			alertObj.classList.add("visible");
			alertObj.timeout = setTimeout(function () {
				document.getElementById("alert").classList.remove("visible");
			}, 7000);
		}

		function GotFollowerList(newList) {
			followers = newList;
			document.getElementById("FollowerCount").innerHTML = followers.length;
		}


		//Set up framework objects.
		function createWebSocket() {
			webSocket = new WebSocket("ws://localhost:8000", "overlay");
			webSocket.addEventListener("message", function (event) {
				var evt = event.data;
				if (typeof evt === "string") evt = JSON.parse(evt);
				console.log("Message Received: %s", event.data);
				switch (evt.type) {
					case "ChatMessage":
						ChatMessage("Chat", evt);
						break;
					case "ChatAction":
						ChatMessage("Action", evt);
						break;
					case "ChatTimeout":
						ChatTimeout(evt);
						break;
					case "StatChanged":
						AddToQueue({ callback: UpdateCounter, arguments: [evt.stat, evt.counter], timeout: 10000 });
						break;
					case "GameChanged":
						UpdateGame(evt.value);
						break;
					case "NewFollower":
						AddToQueue({ callback: NewFollower, arguments: [evt.value], timeout: 10000 });
						break;
					case "GoalUpdated":
						GoalUpdate(evt.goal);
						break;
					case "NewTip":
						AddToQueue({ callback: NewTip, arguments: [evt.tip], timeout: 10000 });
						break;
					case "ToggleWebcam":
						ToggleWebcam();
						break;
					case "FollowerList":
						GotFollowerList(evt.followers);
						break;
					case "ChangeScene":
						switch (evt.data) {
							case "AFK":
								GoAFK();
								break;
							case "Booth":
								GoBooth();
								break;
							case "Game":
								GoGame();
								break;
						}
						break;
					case "UpdateAFK":
						SetAFKMessage(evt.data);
						break;
				}
			});
			webSocket.addEventListener("close", event => {
				//Connection died... Re-open it.
				webSocket = createWebSocket();
			});
			return webSocket;
		}

		var ws = createWebSocket();

		var webcam = new DisplayWebcam(document.getElementById("webcam"));

	</script>
</body>
</html>